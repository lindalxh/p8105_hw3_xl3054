---
title: "p8105_hw3_xl3054"
author: "Xinhui Lin (xl3054)"
date: "2025-10-13"
output: github_document
---

# Problem 1
```{r}
library(tidyverse)
library(p8105.datasets)
data("instacart")
```

The `instacart` dataset has `r nrow(instacart)` rows and `r ncol(instacart)` columns in total. The columns include variables identifying the order, product, customer, aisle, department, time of order, and indicating whether the product was reordered. Within the `r nrow(instacart)` observations, there are `r length(unique(pull(instacart, user_id)))` unique users.

```{r}
aisle_uniq = instacart %>% count(aisle, sort = TRUE)
```

There are `r nrow(aisle_uniq)` aisles. The aisle of fresh vegetables has the most items ordered from.

```{r}
instacart %>% count(aisle, name = "items_ordered") %>% 
  filter(items_ordered > 10000) %>% 
  mutate(aisle = fct_reorder(aisle, items_ordered)) %>% 
  ggplot(aes(x = aisle, y = items_ordered)) + 
  geom_col() + 
  coord_flip() +
  labs(title = "Number of Items Ordered by Aisle (>10000)",
       x = "Aisle",
       y = "Items ordered") +
  theme_minimal()
```

```{r}
instacart %>% filter(aisle %in% 
                       c("baking ingredients", "dog food care", "packaged vegetables fruits")) %>% 
  count(aisle, product_name, sort = TRUE) %>% 
  group_by(aisle) %>% 
  slice_max(n, n = 3) %>% 
  arrange(aisle, desc(n))      
```

```{r}
instacart %>% filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) %>% 
  group_by(product_name, order_dow) %>% 
  summarise(mean_hour = mean(order_hour_of_day), .groups = "drop") %>% 
  mutate(order_dow = recode(order_dow,
                            `0` = "Sunday",
                            `1` = "Monday",
                            `2` = "Tuesday",
                            `3` = "Wednesday",
                            `4` = "Thursday",
                            `5` = "Friday",
                            `6` = "Saturday")) %>%
  pivot_wider(names_from = order_dow,
              values_from = mean_hour)
```


# Problem 2
```{r}
zip_codes = read_csv(file = "./Data/Zip Codes.csv") %>%  ## load data
  janitor::clean_names() %>%  ## clean data
  select(zip_code, county, neighborhood, county_fips) %>%  ## select related columns
  slice(-c(226, 227)) ## remove repeated zipcodes

## zori
zori = read_csv(file = "./Data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") %>%  ## load data
  janitor::clean_names() %>%  ## clean data
  pivot_longer(cols = starts_with("x"), 
    names_to = "date",
    values_to = "zori") %>%  ## pivot longer by dats
  mutate(date = str_remove(date, "^x")) %>%  ## clean date format
  separate(date, into = c("year", "month", "day"), sep = "_") %>%  ## separate into year, month, day
  mutate(year = as.integer(year), 
    month = month.name[as.integer(month)]) %>%
  select(-c(state))  ## make year into integer, month as full name, remove state (repeated)

## merging
combined = right_join(zip_codes, zori, by = c("zip_code" = "region_name")) %>%
  select(year, month, ## time
         zip_code, county_fips, region_id,  ## ids
         state_name, city, county_name, region_type, neighborhood, metro, size_rank,  ## geographic
         zori) ## metric
```

```{r}
obs_116 = combined %>% filter(!is.na(zori)) %>% 
  count(zip_code, sort = TRUE) %>% filter(n==116)
```
`r nrow(obs_116)` ZIP codes are observed 116 times.

```{r}
obs_10 = combined %>% filter(!is.na(zori)) %>% 
  count(zip_code, sort = TRUE) %>% filter(n<10)
```
`r nrow(obs_116)` ZIP codes are observed fewer than 10 times. 

################ xxxxxxxxxxWhy are some ZIP codes are observed rarely and others observed in each month?

```{r}
combined %>%
  group_by(county_name, year) %>%
  summarize(mean_zori = mean(zori, na.rm = TRUE), .groups = "drop") %>%
  arrange(county_name, year) %>% 
  mutate(mean_zori = round(mean_zori, 2)) %>%
  pivot_wider(names_from = year, values_from = mean_zori)
```
############### Comment on trends in this table.

```{r}
zori_all = combined %>%
  filter(!is.na(county_name), !is.na(year), !is.na(zori)) %>%
  group_by(county_name, year, zip_code) %>%
  summarize(mean_zori = mean(zori, na.rm = TRUE), .groups = "drop") %>% 
  ggplot(aes(x = year, y = mean_zori, group = zip_code, color = county_name)) + 
  geom_line(alpha = 0.5) +
  theme_minimal() + 
  scale_x_continuous(breaks = seq(from = min(pull(combined, year), na.rm = TRUE),
                                  to = max(pull(combined, year), na.rm = TRUE),
                                  by = 1)) +
  labs(title = "NYC Rental Prices by ZIP Code and Borough",
       x = "Year",
       y = "Average Rental Price (ZORI)",
       color = "Borough")
```
########## xxxxxxxxxxxx comment on any significant elements of this plot.

```{r}
zori_2023 = combined %>%
  filter(year == 2023, !is.na(county_name), !is.na(month), !is.na(zori)) %>%
  group_by(county_name, zip_code, month) %>%
  summarize(mean_zori = mean(zori, na.rm = TRUE), .groups = "drop") %>% 
  ggplot(aes(x = county_name, y = mean_zori, fill = county_name)) +
  geom_violin(trim = TRUE, alpha = 0.6) +
  geom_boxplot(width = 0.15, outlier.shape = NA, alpha = 0.8, color = "black") +
  theme_minimal() +
  labs(title = "Distribution of 2023 ZIP-Level Rental Prices (ZORI) Across NYC Boroughs",
       x = "Borough",
       y = "Average Monthly Rental Price (ZORI)",
       fill = "Borough")
#  theme(
#    legend.position = "none",
#    plot.title = element_text(face = "bold", size = 14),
#    axis.text.x = element_text(angle = 25, hjust = 1)
#  )
```
################ Comment on this plot

```{r}
## combine two plots and export

```


# Problem 3
```{r}
library(httr)
demographic = read_csv("https://p8105.com/data/nhanes_covar.csv", skip = 4)
accelerometer = read_csv("https://p8105.com/data/nhanes_accel.csv")
acc_merged = left_join(demographic, accelerometer, by = "SEQN")

acc_merged = acc_merged %>%
  janitor::clean_names() %>% 
  filter(age>=21) %>% 
  drop_na(sex, age, bmi, education) %>% 
  mutate(sex = case_when(
      sex == "1" ~ "Male",
      sex == "2" ~ "Female"),
    sex = factor(sex, levels = c("Male", "Female")),
    education = case_when(
      education == "1" ~ "Less than high school",
      education == "2" ~ "High school equivalent", 
      education == "3" ~ "More than high school"), 
    education = factor(education, levels = c("Less than high school", 
                                             "High school equivalent", 
                                             "More than high school")))
```

table
```{r}
acc_merged  %>% 
  count(education, sex, name = "n") %>% 
  pivot_wider(names_from = sex, values_from = n)
```
################ xxxxxxcomment

plot
```{r}
acc_merged %>% ggplot(aes(x = age, fill = sex)) + 
  geom_density(alpha = 0.3) + 
  facet_wrap(~ education, nrow = 1) +
  theme_minimal() + 
  labs(
    title = "Age distributions by sex and education", 
    x = "Age (years)", 
    y = "Density", 
    fill = "Sex"
  )
```
################ xxxxxxcomment

total activity
```{r}
acc_merged %>% 
  pivot_longer(
    cols = matches("^min", ignore.case = TRUE),
    names_to = "minute_var",
    values_to = "mims") %>% 
  group_by(seqn) %>% 
  summarise(total_mims = sum(mims),
            .groups = "drop") %>% 
  left_join(acc_merged[,1:5], by = "seqn") %>% 
  ggplot(aes(x = age, y = total_mims, color = sex)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(se = FALSE) + 
  facet_wrap(~ education) +
  theme_minimal() +
  labs(title = "Total daily activity (MIMS) vs Age",
       x = "Age (years)",
       y = "Total MIMS (per day)",
       color = "Sex")
```
################ xxxxxxcomment


```{r}
acc_merged %>% 
  pivot_longer(
    cols = matches("^min", ignore.case = TRUE),
    names_to = "minute_var",
    values_to = "mims") %>% 
  mutate(minute = as.integer(str_remove(minute_var, "^min")),
         hour = minute / 60) %>% 
  ggplot(aes(x = hour, y = mims, color = sex)) +
  geom_smooth() +
  facet_wrap(~ education, ncol = 1) + 
  labs(x = "Hour of Day",
       y = "Activity (MIMS units)",
       title = "24-hour Accelerometer Activity by Education Level and Sex",
       color = "Sex") +
  theme_minimal()
```




